<?
//
// $Id$
//
require_once("f_runmode.phtml");
$mode = "";
if (RunMode($PHP_SELF)) error_reporting(E_ALL);
//
require_once("f_oscarhomepageurl.phtml");
require_once("f_putlibphotorandomplaced.phtml");
require_once("f_bodyopen.phtml");
require_once("f_connectselectdbinstanceunpublished.phtml");
require_once("f_roleemailaddress.phtml");
require_once("f_oscarmailheaders.phtml");
//
?>
<html>
<head><title>Modify Squad Participant Status</title></head>
<? BodyOpen(); ?>
<table align=center width=80%><tr><td>
<H6 ALIGN=CENTER>KVEO-IT-PROJECT<br><a href=<? OscarHomePageUrl() ?>>OSCAR SYSTEM</a><br><a href=http://www.vabeachems.com>VIRGINIA BEACH DEPARTMENT OF EMS</a></H6>
<H1 ALIGN=CENTER>Modify Squad Participant Status</H1>
<hr>
<?
if ($token != "")
   {
   //
   // Connect to the database.
   //
   if (ConnectSelectDbInstanceUNPUBLISHED($db_link) == "TRUE")
      {
      //
      // Get the parameters associated with the token.
      //
      $result = $db_link->query
         (
         "select enumeral, new_be_active from " . $mode . "pend_mod_agency where token='$token' "
         )
         or die("Query failed with error: " . mysqli_error($db_link));
      if (mysqli_num_rows($result))
         {
         extract(mysqli_fetch_array($result));
         //
         // Perform the specified update.
         //
         $sql = "update " . $mode . "agency "
            .  "set be_active='$new_be_active' "
            .  "where enumeral='$enumeral' ";
         $db_link->query($sql) or die("Update failed with error: " . mysqli_error($db_link));
         //
         // This single change can have major ramifications for hundreds of individuals.  Notify sysadmin.
         //
         @mail
            (
            RoleEmailAddress($db_link,"",$mode),
            "OSCAR Participant Change",
            stripslashes
               (
               "The \'OSCAR - "
               . $mode
               . "perform-mod-agency.phtml\' script has processed the following operation on behalf of the Master OSCAR "
               . "Authority:\n\n$sql"
               )
            );
         //
         // Clean up the pending operation record.
         //
         $db_link->query
            (
            "delete from " . $mode . "pend_mod_agency where token='$token' "
            )
            or die("Clean-up failed with error: " . mysqli_error($db_link));
         //
         PutLibPhotoRandomPlaced("oscarsystem",1,"right");
         echo "<p>The status of agency '$enumeral' has been changed to ";
         if ($new_be_active == "FALSE") echo "NON";
         echo "PARTICIPANT.</p>\n"
            . "Related destinations:\n"
            . "<ul>\n"
            . "   <li><a href=" . $mode . "form-set-agency.phtml>Toggle Squad Participation page</a></li>\n"
            . "   <li><a href=" . $mode . "modify.phtml>Modify other OSCAR settings</a></li>\n"
            . "   <li><a href=" . $mode . "index.phtml>Main OSCAR page</a></li>\n"
            . "</ul>\n";
         }
      else
         {
         //
         // Fill the page out with a warning and instructions.
         //
         ?>
         <h2><i>Error!</i></h2>
         <b>
         <blockquote>
            <p>Specified token not found.&nbsp; Consider:</p>
            <ul>
               <li>Make sure the URL in your browser's address field exactly matches the URL
                  in your challenge email message.</li>
               <li>Maybe you have already completed this modification.</li>
            </ul>
            <p>If the above hints don't help, contact the <a href=mailto:"<? echo RoleEmailAddress($db_link,"",$mode); ?>">OSCAR
               System Administrator</a>.</p>
         </blockquote>            
         </b>
         <?
         }
      }
   else
      {
      //
      // Fill the page out with a warning and instructions.
      //
      ?>
      <h2><i>Sorry...</i></h2>
      <b>
      <blockquote>
         <p>OSCAR's database is temporarily unavailable.&nbsp; Please try your modification operation later.</p>
      </blockquote>            
      </b>
      <?
      }
   }
else
   {
   //
   // Fill the page out with a warning and instructions.
   //
   ?>
   <h2><i>Error!</i></h2>
   <b>
   <blockquote>
      <p>Invalid arguments.</p>
   </blockquote>            
   </b>
   <?
   }
?>
<br clear=both>
<hr>
<p><small><small><em><pre>$Id$</pre></em></small></small>
</td>
</tr>
</table>
</body>
</html>
